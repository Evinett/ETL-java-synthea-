# ETL-Java-Synthea to OMOP CDM
# Roger Ward, 3 August 2025

## Overview

This project is a Java-based ETL (Extract, Transform, Load) application designed to convert synthetic patient data generated by **Syntheaâ„¢** into the **OMOP Common Data Model (CDM)** format.

The primary goal is to take the raw, denormalized CSV files from Synthea, along with the standard OMOP vocabulary files, and populate a fully structured, relational OMOP CDM instance within a PostgreSQL database. This allows the realistic but non-real patient data from Synthea to be used with the suite of OHDSI tools and for standardized health analytics research.

---

## How It Works: A Two-Stage ETL Pipeline

The application is designed as a two-stage pipeline to separate the one-time setup of the static OMOP Vocabulary from the repeatable process of loading patient data. This makes subsequent runs much faster. The main logic is orchestrated in `EtlRunner.java` and is controlled by a command-line argument.

### Stage 1: Vocabulary Loading (One-Time Setup)

This stage is run once to prepare the database. It is triggered by passing the `--load-vocab` argument.

1.  **Schema and Table Creation**: Creates the `native` and `cdm_synthea` schemas if they don't exist. It then creates all the standard OMOP CDM tables.
2.  **Vocabulary Ingestion**: Bulk-loads the OMOP vocabulary CSV files (e.g., `CONCEPT.csv`, `CONCEPT_RELATIONSHIP.csv`) into the `cdm_synthea` schema using a high-performance `COPY`-based loader.

### Stage 2: Synthea Data ETL (Repeatable)

This is the main ETL process, run without any special arguments. It assumes Stage 1 has already been completed.

1.  **Data Cleanup**: Before loading new data, it cleans up the *previous run's data*. It does this by **truncating** all clinical event tables (like `person`, `visit_occurrence`, etc.) and completely dropping/recreating the `native` staging schema. The large vocabulary tables are left untouched.
2.  **Synthea Data Ingestion**: Bulk-loads the Synthea-generated CSV files into the `native` schema.
3.  **Transformation**: Executes a series of SQL scripts to create helper tables for mapping and visit rollups (e.g., `source_to_concept_map`, `visit_occurrence_rollup`).
4.  **Final Load**: Populates the final OMOP CDM tables by reading from the `native` schema, applying the mappings, and inserting the transformed data into the `cdm_synthea` schema.

---

## Inputs

The ETL process requires two sets of data as input, with paths configured in `EtlRunner.java`:

1.  **Synthea Data CSVs**:
    - **Source**: Generated by the Synthea Patient Simulator.
    - **Location**: Configured via the `SYNTHEA_CSV_PATH` variable.
    - **Format**: Comma-separated values (`.csv`).
    - **Example Files**: `patients.csv`, `encounters.csv`, `conditions.csv`, etc.

2.  **OMOP Vocabulary CSVs**:
    - **Source**: Downloadable from the Athena vocabulary repository.
    - **Location**: Configured via the `VOCAB_CSV_PATH` variable.
    - **Format**: Tab-separated values (`.csv`).
    - **Example Files**: `CONCEPT.csv`, `VOCABULARY.csv`, `CONCEPT_RELATIONSHIP.csv`, `SOURCE_TO_CONCEPT_MAP.csv`, etc.

---

## Outputs

The final output is a set of schemas in the target PostgreSQL database, ready for analysis.

- **CDM Data Schema**: `cdm_synthea` (or as configured).
  - **Contents**: Standard OMOP CDM tables populated with data derived from Synthea.
- **Achilles Results Schema**: `results_synthea` (or as configured).
  - **Contents**: An empty schema, ready to receive the output from the Achilles data characterization tool. This schema is dropped and recreated on each main ETL run.

- Key populated tables in the `cdm_synthea` schema include:
  - `person`
  - `observation_period`
  - `visit_occurrence`
  - `visit_detail`
  - `condition_occurrence`
  - `drug_exposure`
  - `procedure_occurrence`
  - `measurement`
  - `observation`
  - `location`
  - `care_site`
  - `provider`
  - `cost`
  - `payer_plan_period`
  - `condition_era`
  - `drug_era`
  - `cdm_source`

---

## How to Run

1.  **Prerequisites**:
    - **Java JDK 11 or higher** installed.
    - **PostgreSQL 12 or higher** running and accessible.
    - Synthea and Vocabulary CSV files downloaded to your local machine.

2.  **PostgreSQL Setup**:
    - Ensure PostgreSQL is running on your system.
    - Create a database for the ETL process (e.g., `Syn_CDM`).
    - Ensure the database user has sufficient privileges to create schemas and tables.
    - Test your connection:
      ```bash
      psql -h localhost -U your_username -d your_database
      ```

3.  **Configuration**:
    - **Database Connection**: Edit `DatabaseManager.java` to match your PostgreSQL setup:
      ```java
      config.setJdbcUrl("jdbc:postgresql://localhost:5432/your_database");
      config.setUsername("your_username");
      config.setPassword("your_password");
      ```
    - **Data Paths**: Edit `EtlRunner.java` to set the correct paths:
      ```java
      private static final String SYNTHEA_CSV_PATH = "/path/to/your/synthea/output/csv";
      private static final String VOCAB_CSV_PATH = "/path/to/your/vocabulary/files";
      ```
    - **Schema Names** (optional): Modify if you want different schema names:
      ```java
      private static final String CDM_SCHEMA = "cdm_synthea";
      private static final String SYNTHEA_SCHEMA = "native";
      private static final String ACHILLES_RESULTS_SCHEMA = "results_synthea";
      ```

4.  **Execution (Stage 1: Vocabulary Load)**:
    - Run this command **only once**, or whenever you update your OMOP vocabulary files.
    - From your IDE or command line, run the `EtlRunner` main class with the `--load-vocab` argument.
    - Using Maven:
      ```bash
      mvn exec:java -Dexec.mainClass="com.example.syntheaetl.EtlRunner" -Dexec.args="--load-vocab"
      ```

5.  **Execution (Stage 2: Synthea ETL)**:
    - Run this command whenever you want to process Synthea data.
    - From your IDE or command line, run the `EtlRunner` main class with **no arguments**.
    - Using Maven:
      ```bash
      mvn exec:java -Dexec.mainClass="com.example.syntheaetl.EtlRunner"
      ```

---

## Troubleshooting

### Common Issues

1. **PostgreSQL Connection Errors**:
   - Ensure PostgreSQL is running: `brew services start postgresql` (macOS) or `sudo systemctl start postgresql` (Linux)
   - Verify database exists and user has proper permissions
   - Check connection string in `DatabaseManager.java`

2. **Schema Drop Timeout**:
   - If you get "canceling statement due to user request" errors, there may be active connections
   - Check for active connections: `SELECT pid, state, query FROM pg_stat_activity WHERE datname = 'your_database';`
   - Terminate blocking connections: `SELECT pg_terminate_backend(pid);`

3. **File Path Errors**:
   - Ensure all CSV file paths in `EtlRunner.java` are absolute paths
   - Verify Synthea CSV files exist and are readable
   - Check vocabulary files are in the correct directory

4. **Memory Issues**:
   - For large datasets, consider increasing JVM heap size: `export MAVEN_OPTS="-Xmx4g"`
   - Monitor PostgreSQL memory settings for large vocabulary loads

### Performance Tips

- Vocabulary loading is a one-time operation that can take 5-10 minutes
- Subsequent Synthea ETL runs are much faster (30-60 seconds)
- Use SSD storage for better I/O performance
- Consider increasing PostgreSQL `shared_buffers` for large datasets
